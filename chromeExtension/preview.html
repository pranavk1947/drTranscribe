<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>MedLog - Live Simulation Preview</title>
    <style>
        /* Simulated Google Meet background */
        body {
            margin: 0;
            background: #202124;
            font-family: 'Google Sans', 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            overflow: hidden;
        }

        .fake-meet {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column;
        }
        .fake-meet-top {
            height: 56px;
            background: #202124;
            border-bottom: 1px solid #3c4043;
            display: flex;
            align-items: center;
            padding: 0 24px;
            color: #e8eaed;
            font-size: 16px;
            gap: 16px;
        }
        .fake-meet-top svg { width: 24px; height: 24px; fill: #e8eaed; }
        .fake-meet-code { color: #5f6368; font-size: 14px; font-family: 'Google Sans', monospace; }
        .fake-meet-time { margin-left: auto; color: #9aa0a6; font-size: 13px; }

        .fake-meet-video {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            padding: 24px;
            padding-right: 340px;
            padding-left: 360px;
        }
        .fake-participant {
            flex: 1;
            max-width: 560px;
            aspect-ratio: 16/10;
            background: #3c4043;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #9aa0a6;
            gap: 12px;
            position: relative;
        }
        .fake-avatar {
            width: 88px;
            height: 88px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            color: #fff;
            font-weight: 500;
        }
        .fake-avatar.doctor { background: #4285f4; }
        .fake-avatar.patient { background: #34a853; }
        .fake-name { font-size: 14px; color: #e8eaed; }
        .fake-speaking-ring {
            position: absolute;
            inset: -3px;
            border-radius: 11px;
            border: 3px solid transparent;
            transition: border-color 0.3s;
        }
        .fake-speaking-ring.active {
            border-color: #4285f4;
        }

        /* Live conversation transcript */
        .fake-transcript {
            position: fixed;
            bottom: 88px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(32, 33, 36, 0.9);
            border-radius: 8px;
            padding: 10px 16px;
            color: #e8eaed;
            font-size: 14px;
            max-width: 600px;
            text-align: center;
            line-height: 1.5;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 100;
        }
        .fake-transcript.visible { opacity: 1; }
        .fake-transcript .speaker { color: #8ab4f8; font-weight: 500; }

        .fake-meet-bar {
            height: 72px;
            background: #202124;
            border-top: 1px solid #3c4043;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            padding-right: 340px;
            padding-left: 360px;
        }
        .fake-meet-btn {
            width: 44px; height: 44px;
            border-radius: 50%;
            background: #3c4043;
            border: none;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .fake-meet-btn svg { width: 20px; height: 20px; fill: #e8eaed; }
        .fake-meet-btn.red { background: #ea4335; }

        /* ─── SIMULATION CONTROLS (bottom-left) ─── */
        .sim-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 999999999;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .sim-controls button {
            padding: 10px 20px;
            border: 1px solid #2e3648;
            border-radius: 8px;
            background: #1e2430;
            color: #e0e6f0;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            font-family: inherit;
            transition: all 0.15s;
        }
        .sim-controls button:hover { background: #252d3e; }
        .sim-controls button.sim-active {
            background: #c5d952;
            color: #141820;
            border-color: #c5d952;
        }
        .sim-controls button.sim-stop {
            background: #f06070;
            color: #141820;
            border-color: #f06070;
        }
        .sim-timer {
            font-size: 12px;
            color: #5a6878;
            text-align: center;
            font-family: monospace;
        }
        .sim-label {
            font-size: 11px;
            color: #4a5568;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* ═══════════════════════════════════════════════════════════
           ACTUAL EXTENSION CSS (ported from content.css)
           ═══════════════════════════════════════════════════════════ */

        /* Badge */
        .drt-badge {
            position: fixed;
            bottom: 80px;
            right: 24px;
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: #3d5f5c;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 6px;
            cursor: pointer;
            z-index: 2147483646;
            transition: transform 0.15s, box-shadow 0.2s;
            user-select: none;
            overflow: hidden;
        }
        .drt-badge:hover { transform: scale(1.1); }
        .drt-badge-detected {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        .drt-badge-active {
            box-shadow: 0 0 16px rgba(197, 217, 82, 0.5), 0 2px 8px rgba(0, 0, 0, 0.3);
            animation: drt-badge-pulse 2s ease-in-out infinite;
        }
        @keyframes drt-badge-pulse {
            0%, 100% { box-shadow: 0 0 16px rgba(197, 217, 82, 0.5), 0 2px 8px rgba(0, 0, 0, 0.3); }
            50% { box-shadow: 0 0 24px rgba(197, 217, 82, 0.7), 0 2px 8px rgba(0, 0, 0, 0.3); }
        }

        /* Panel */
        .drt-panel {
            position: fixed;
            top: 80px;
            right: 16px;
            width: 300px;
            max-height: calc(100vh - 100px);
            background: #141820;
            border: 1px solid #2a3040;
            border-radius: 14px;
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.6);
            z-index: 2147483647;
            font-family: 'Google Sans', 'Segoe UI', Roboto, sans-serif;
            font-size: 12px;
            color: #e0e6f0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: box-shadow 0.2s;
        }
        .drt-panel:hover { box-shadow: 0 12px 56px rgba(0, 0, 0, 0.7); }

        /* Header */
        .drt-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: #181d28;
            cursor: grab;
            user-select: none;
            border-bottom: 1px solid #2a3040;
        }
        .drt-header:active { cursor: grabbing; }
        .drt-brand { display: flex; align-items: center; gap: 10px; }

        .drt-logo-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #1e2430;
            border: 2px solid #5a6a4a;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 13px;
            color: #c5d952;
            flex-shrink: 0;
        }

        .drt-logo { font-weight: 700; font-size: 15px; color: #f0f4ff; letter-spacing: -0.3px; }

        .drt-status {
            font-size: 11px;
            font-weight: 600;
            color: #c5d952;
            padding: 3px 10px;
            border-radius: 12px;
            background: rgba(197, 217, 82, 0.15);
            white-space: nowrap;
        }
        .drt-status::before {
            content: '\25CF';
            margin-right: 4px;
            font-size: 8px;
        }
        .drt-status-connecting { color: #f9e2af; background: rgba(249, 226, 175, 0.12); }
        .drt-status-recording { color: #c5d952; background: rgba(197, 217, 82, 0.15); animation: drt-pulse 1.5s ease-in-out infinite; }
        .drt-status-error { color: #f38ba8; background: rgba(243, 139, 168, 0.12); }
        @keyframes drt-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

        .drt-controls { display: flex; gap: 4px; }
        .drt-btn-icon {
            background: #232a38; border: 1px solid #2e3648; color: #8090a8; cursor: pointer;
            padding: 6px 10px; border-radius: 8px; font-size: 13px; line-height: 1;
            transition: background 0.15s, color 0.15s;
        }
        .drt-btn-icon:hover { background: #2e3648; color: #e0e6f0; }

        /* Body */
        .drt-body {
            overflow-y: auto; flex: 1; padding: 10px;
            display: flex; flex-direction: column; gap: 10px;
        }
        .drt-body::-webkit-scrollbar { width: 4px; }
        .drt-body::-webkit-scrollbar-track { background: transparent; }
        .drt-body::-webkit-scrollbar-thumb { background: #2e3648; border-radius: 2px; }

        /* Patient Display */
        .drt-patient-display {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #232a38;
        }
        .drt-patient-avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: #1e2430;
            border: 2px solid #5a6a4a;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 13px;
            color: #c5d952;
            flex-shrink: 0;
        }
        .drt-patient-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .drt-patient-name {
            font-size: 14px;
            font-weight: 600;
            color: #f0f4ff;
        }
        .drt-patient-meta {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .drt-patient-tag {
            font-size: 10px;
            font-weight: 500;
            color: #8090a8;
            background: #232a38;
            padding: 2px 8px;
            border-radius: 10px;
            white-space: nowrap;
        }

        /* Patient Form */
        .drt-section-title {
            font-size: 11px; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.5px; color: #6c7a8e; margin-bottom: 8px;
        }
        .drt-form-row { margin-bottom: 8px; }
        .drt-form-row-split { display: flex; gap: 8px; }
        .drt-input {
            width: 100%; padding: 10px 12px; background: #1e2430;
            border: 1px solid #2e3648; border-radius: 10px; color: #e0e6f0;
            font-size: 13px; font-family: inherit; outline: none;
            transition: border-color 0.15s; box-sizing: border-box;
        }
        .drt-input:focus { border-color: #c5d952; box-shadow: 0 0 0 3px rgba(197, 217, 82, 0.08); }
        .drt-input:disabled { opacity: 0.4; cursor: not-allowed; }
        .drt-input-small { width: 80px; flex-shrink: 0; }
        .drt-input option { background: #1e2430; color: #e0e6f0; }

        /* Session Controls */
        .drt-session-controls { display: flex; gap: 8px; }
        .drt-btn {
            flex: 1; padding: 9px 12px; border: none; border-radius: 10px;
            font-size: 12px; font-weight: 700; font-family: inherit;
            cursor: pointer; transition: all 0.15s; letter-spacing: 0.2px;
        }
        .drt-btn:disabled { opacity: 0.35; cursor: not-allowed; }
        .drt-btn-start { background: #c5d952; color: #141820; }
        .drt-btn-start:hover:not(:disabled) { background: #d4e65e; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(197, 217, 82, 0.3); }
        .drt-btn-stop { background: #2a1520; color: #f06070; border: 1px solid #3a2030; }
        .drt-btn-stop:hover:not(:disabled) { background: #351a28; border-color: #4a2838; }

        /* Result Cards */
        .drt-results { display: flex; flex-direction: column; gap: 6px; }
        .drt-card {
            background: #1a2030; border: 1px solid #252d3e; border-radius: 10px;
            padding: 10px 12px; border-left: 3px solid #2e3648;
            transition: border-color 0.2s, background 0.2s;
        }
        .drt-card:hover { background: #1e2538; }

        /* Card accent colors */
        .drt-card-chief { border-left-color: #c5d952; }
        .drt-card-diagnosis { border-left-color: #ff6b8a; }
        .drt-card-medicine { border-left-color: #f0a030; }
        .drt-card-advice { border-left-color: #39d2c0; }
        .drt-card-nextsteps { border-left-color: #bc8cff; }

        .drt-card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }
        .drt-card-icon {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            background: #232a38;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }
        .drt-card-title {
            font-size: 11px; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.6px; flex: 1;
        }
        /* Card title colors matching accent */
        .drt-card-chief .drt-card-title { color: #c5d952; }
        .drt-card-diagnosis .drt-card-title { color: #ff6b8a; }
        .drt-card-medicine .drt-card-title { color: #f0a030; }
        .drt-card-advice .drt-card-title { color: #39d2c0; }
        .drt-card-nextsteps .drt-card-title { color: #bc8cff; }

        .drt-card-badge {
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #5a6878;
            white-space: nowrap;
        }
        .drt-card-badge.drt-badge-updated {
            color: #c5d952;
        }

        .drt-card-content {
            font-size: 12px; line-height: 1.5; color: #c0c8d8;
            white-space: pre-wrap; word-break: break-word;
        }
        .drt-card-content.drt-empty { color: #4a5568; font-style: italic; }

        .drt-card.drt-card-updating {
            background: #1e2538;
            border-color: rgba(197, 217, 82, 0.25);
        }

        /* Post-session styles */
        .drt-card-textarea {
            width: 100%; min-height: 60px; padding: 10px 12px;
            background: #1e2430; border: 1px solid #2e3648; border-radius: 8px;
            color: #e0e6f0; font-size: 13px; font-family: inherit;
            line-height: 1.5; outline: none; resize: vertical;
            box-sizing: border-box; transition: border-color 0.15s;
        }
        .drt-card-textarea:focus { border-color: #c5d952; box-shadow: 0 0 0 3px rgba(197, 217, 82, 0.08); }
        .drt-card-textarea::placeholder { color: #4a5568; font-style: italic; }

        .drt-export-bar {
            padding-top: 14px; margin-top: 4px;
            border-top: 1px solid #232a38;
        }
        .drt-export-actions {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 6px; margin-bottom: 8px;
        }
        .drt-btn-export {
            padding: 10px 12px; background: #1e2430; border: 1px solid #2e3648;
            border-radius: 10px; color: #c0c8d8; font-size: 12px; font-weight: 600;
            font-family: inherit; cursor: pointer;
            transition: background 0.15s, border-color 0.15s; text-align: center;
        }
        .drt-btn-export:hover { background: #252d3e; border-color: #3a4458; }
        .drt-btn-export-primary {
            background: #c5d952; color: #141820; border-color: #c5d952; font-weight: 700;
        }
        .drt-btn-export-primary:hover { background: #d4e65e; border-color: #d4e65e; }

        .drt-btn-new-session {
            width: 100%; padding: 10px 12px; background: transparent;
            border: 1px dashed #2e3648; border-radius: 10px; color: #6c7a8e;
            font-size: 12px; font-weight: 600; font-family: inherit; cursor: pointer;
            transition: background 0.15s, color 0.15s, border-color 0.15s;
        }
        .drt-btn-new-session:hover {
            background: #1e2430; color: #e0e6f0; border-color: #3a4458;
        }

        /* Footer */
        .drt-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: #181d28;
            border-top: 1px solid #2a3040;
            font-size: 10px;
            color: #4a5568;
        }
        .drt-footer-version { color: #4a5568; }
        .drt-footer-status { color: #5a6878; font-weight: 600; }
        .drt-footer-recording { color: #c5d952; animation: drt-pulse 1.5s ease-in-out infinite; }

        /* ═══════════════════════════════════════════════════════════
           EMR PANEL (Left Side)
           ═══════════════════════════════════════════════════════════ */

        .emr-panel {
            position: fixed;
            top: 80px;
            left: 16px;
            width: 340px;
            max-height: calc(100vh - 100px);
            background: #141820;
            border: 1px solid #2a3040;
            border-radius: 14px;
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.6);
            z-index: 2147483645;
            font-family: 'Google Sans', 'Segoe UI', Roboto, sans-serif;
            font-size: 12px;
            color: #e0e6f0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .emr-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: #181d28;
            border-bottom: 1px solid #2a3040;
        }
        .emr-panel-brand {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .emr-panel-icon {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            background: #1e2430;
            border: 1px solid #2e3648;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        .emr-panel-title {
            font-weight: 700;
            font-size: 14px;
            color: #f0f4ff;
        }
        .emr-panel-status {
            font-size: 10px;
            font-weight: 600;
            padding: 3px 10px;
            border-radius: 12px;
            background: rgba(90, 104, 120, 0.2);
            color: #5a6878;
            white-space: nowrap;
        }
        .emr-panel-status.emr-status-active {
            background: rgba(197, 217, 82, 0.15);
            color: #c5d952;
            animation: drt-pulse 1.5s ease-in-out infinite;
        }
        .emr-panel-status.emr-status-received {
            background: rgba(57, 210, 192, 0.15);
            color: #39d2c0;
        }
        .emr-panel-body {
            overflow-y: auto;
            flex: 1;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .emr-panel-body::-webkit-scrollbar { width: 4px; }
        .emr-panel-body::-webkit-scrollbar-track { background: transparent; }
        .emr-panel-body::-webkit-scrollbar-thumb { background: #2e3648; border-radius: 2px; }

        .emr-section-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #6c7a8e;
            margin-bottom: 6px;
        }
        .emr-form-row {
            margin-bottom: 8px;
        }
        .emr-form-row-split {
            display: flex;
            gap: 8px;
        }
        .emr-input {
            width: 100%;
            padding: 8px 10px;
            background: #1e2430;
            border: 1px solid #2e3648;
            border-radius: 8px;
            color: #e0e6f0;
            font-size: 12px;
            font-family: inherit;
            outline: none;
            box-sizing: border-box;
        }
        .emr-input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .emr-input-small { width: 80px; flex-shrink: 0; }
        .emr-input option { background: #1e2430; color: #e0e6f0; }
        .emr-textarea {
            width: 100%;
            padding: 8px 10px;
            background: #1e2430;
            border: 1px solid #2e3648;
            border-radius: 8px;
            color: #e0e6f0;
            font-size: 12px;
            font-family: inherit;
            outline: none;
            resize: vertical;
            box-sizing: border-box;
            line-height: 1.4;
        }
        .emr-textarea:disabled { opacity: 0.5; cursor: not-allowed; }

        .emr-btn-start {
            width: 100%;
            padding: 10px 12px;
            background: #c5d952;
            color: #141820;
            border: none;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 700;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.15s;
        }
        .emr-btn-start:hover:not(:disabled) {
            background: #d4e65e;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(197, 217, 82, 0.3);
        }
        .emr-btn-start:disabled { opacity: 0.35; cursor: not-allowed; }

        /* EMR Result Cards */
        .emr-results { display: flex; flex-direction: column; gap: 6px; }
        .emr-result-card {
            background: #1a2030;
            border: 1px solid #252d3e;
            border-radius: 8px;
            padding: 8px 10px;
            border-left: 3px solid #2e3648;
        }
        .emr-result-card-chief { border-left-color: #c5d952; }
        .emr-result-card-diagnosis { border-left-color: #ff6b8a; }
        .emr-result-card-medicine { border-left-color: #f0a030; }
        .emr-result-card-advice { border-left-color: #39d2c0; }
        .emr-result-card-nextsteps { border-left-color: #bc8cff; }

        .emr-result-title {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #6c7a8e;
            margin-bottom: 4px;
        }
        .emr-result-content {
            font-size: 12px;
            line-height: 1.4;
            color: #c0c8d8;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .emr-result-content.emr-empty {
            color: #4a5568;
            font-style: italic;
        }
        .emr-waiting-message {
            text-align: center;
            padding: 20px 12px;
            color: #5a6878;
            font-style: italic;
            font-size: 12px;
        }
        .emr-footer {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            background: #181d28;
            border-top: 1px solid #2a3040;
            font-size: 10px;
            color: #4a5568;
        }

        /* Toast */
        .drt-toast {
            position: fixed; bottom: 80px; right: 24px;
            padding: 12px 20px; background: #232a38; border: 1px solid #2e3648;
            border-radius: 10px; color: #e0e6f0;
            font-family: 'Google Sans', 'Segoe UI', Roboto, sans-serif;
            font-size: 13px; font-weight: 500; z-index: 2147483647;
            opacity: 0; transform: translateY(10px);
            transition: opacity 0.3s, transform 0.3s; pointer-events: none;
        }
        .drt-toast-visible { opacity: 1; transform: translateY(0); }

        .drt-input[type="number"]::-webkit-inner-spin-button,
        .drt-input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .drt-input[type="number"] { -moz-appearance: textfield; }
    </style>
</head>
<body>

    <!-- EMR Panel (Left Side) -->
    <div class="emr-panel" id="emr-panel">
        <div class="emr-panel-header">
            <div class="emr-panel-brand">
                <div class="emr-panel-icon">&#x1F3E5;</div>
                <span class="emr-panel-title">EMR System</span>
            </div>
            <span class="emr-panel-status" id="emr-status">Ready</span>
        </div>

        <div class="emr-panel-body" id="emr-body">
            <!-- EMR Form (pre-session) -->
            <div id="emr-form-section">
                <div class="emr-section-title">New Consultation</div>
                <div class="emr-form-row">
                    <input type="text" id="emr-appointment-id" class="emr-input" placeholder="Appointment ID" value="APT-2024-001" />
                </div>
                <div class="emr-form-row">
                    <input type="text" id="emr-patient-name" class="emr-input" placeholder="Patient Name" />
                </div>
                <div class="emr-form-row emr-form-row-split">
                    <input type="number" id="emr-patient-age" class="emr-input emr-input-small" placeholder="Age" />
                    <select id="emr-patient-gender" class="emr-input">
                        <option value="" disabled selected>Gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="emr-form-row">
                    <textarea id="emr-patient-history" class="emr-textarea" placeholder="Patient medical history..." rows="3"></textarea>
                </div>
                <div class="emr-form-row">
                    <input type="text" id="emr-gmeet-link" class="emr-input" placeholder="Google Meet Link" value="https://meet.google.com/rxj-knwb-yzm" />
                </div>
                <button class="emr-btn-start" id="emr-start-btn">Start Consult</button>
            </div>

            <!-- EMR Waiting State (during session) -->
            <div id="emr-waiting-section" style="display: none;">
                <div class="emr-section-title">Active Session</div>
                <div class="drt-patient-display" style="display: flex;">
                    <div class="drt-patient-avatar" id="emr-patient-avatar">RS</div>
                    <div class="drt-patient-details">
                        <div class="drt-patient-name" id="emr-patient-name-display">Rahul Sharma</div>
                        <div class="drt-patient-meta">
                            <span class="drt-patient-tag" id="emr-patient-age-tag">45 yrs</span>
                            <span class="drt-patient-tag" id="emr-patient-gender-tag">Male</span>
                            <span class="drt-patient-tag" id="emr-appt-tag">APT-2024-001</span>
                        </div>
                    </div>
                </div>
                <div class="emr-waiting-message" id="emr-waiting-msg">
                    Recording in progress in Google Meet...<br>
                    Waiting for consultation to end.
                </div>
            </div>

            <!-- EMR Results (post-export) -->
            <div id="emr-results-section" style="display: none;">
                <div class="emr-section-title">Received Results</div>
                <div class="drt-patient-display" style="display: flex;">
                    <div class="drt-patient-avatar">RS</div>
                    <div class="drt-patient-details">
                        <div class="drt-patient-name">Rahul Sharma</div>
                        <div class="drt-patient-meta">
                            <span class="drt-patient-tag">45 yrs</span>
                            <span class="drt-patient-tag">Male</span>
                            <span class="drt-patient-tag">APT-2024-001</span>
                        </div>
                    </div>
                </div>
                <div class="emr-results" id="emr-results">
                    <div class="emr-result-card emr-result-card-chief">
                        <div class="emr-result-title">Chief Complaint</div>
                        <div class="emr-result-content emr-empty" id="emr-res-chief">--</div>
                    </div>
                    <div class="emr-result-card emr-result-card-diagnosis">
                        <div class="emr-result-title">Diagnosis</div>
                        <div class="emr-result-content emr-empty" id="emr-res-diagnosis">--</div>
                    </div>
                    <div class="emr-result-card emr-result-card-medicine">
                        <div class="emr-result-title">Medicine</div>
                        <div class="emr-result-content emr-empty" id="emr-res-medicine">--</div>
                    </div>
                    <div class="emr-result-card emr-result-card-advice">
                        <div class="emr-result-title">Advice</div>
                        <div class="emr-result-content emr-empty" id="emr-res-advice">--</div>
                    </div>
                    <div class="emr-result-card emr-result-card-nextsteps">
                        <div class="emr-result-title">Next Steps</div>
                        <div class="emr-result-content emr-empty" id="emr-res-nextsteps">--</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="emr-footer">
            EMR Demo &middot; Integrated with MedLog
        </div>
    </div>

    <!-- Simulated Google Meet -->
    <div class="fake-meet">
        <div class="fake-meet-top">
            <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
            <span>Google Meet</span>
            <span class="fake-meet-code">rxj-knwb-yzm</span>
            <span class="fake-meet-time" id="meet-time">0:00</span>
        </div>
        <div class="fake-meet-video">
            <div class="fake-participant" id="doctor-tile">
                <div class="fake-speaking-ring" id="doctor-ring"></div>
                <div class="fake-avatar doctor">D</div>
                <span class="fake-name">Dr. Priya Mehta</span>
            </div>
            <div class="fake-participant" id="patient-tile">
                <div class="fake-speaking-ring" id="patient-ring"></div>
                <div class="fake-avatar patient">R</div>
                <span class="fake-name">Rahul Sharma</span>
            </div>
        </div>
        <div class="fake-meet-bar">
            <button class="fake-meet-btn"><svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg></button>
            <button class="fake-meet-btn"><svg viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg></button>
            <button class="fake-meet-btn red"><svg viewBox="0 0 24 24"><path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7 0-.28.11-.53.29-.71C3.34 8.78 7.46 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.71l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28-.79-.74-1.69-1.36-2.67-1.85-.33-.16-.56-.5-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z" fill="#fff"/></svg></button>
            <button class="fake-meet-btn"><svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg></button>
            <button class="fake-meet-btn"><svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg></button>
        </div>
    </div>

    <!-- Live conversation subtitle -->
    <div class="fake-transcript" id="transcript-bar"></div>

    <!-- MedLog BADGE -->
    <div class="drt-badge drt-badge-detected" id="drt-badge" title="MedLog - Click to open">
        <div class="drt-logo-icon" style="width:32px;height:32px;font-size:15px;border:none;background:transparent;color:#c5d952;">M</div>
    </div>

    <!-- MedLog PANEL (initially hidden) -->
    <div class="drt-panel" id="drt-panel" style="display: none;">
        <div class="drt-header" id="drt-header">
            <div class="drt-brand">
                <div class="drt-logo-icon">M</div>
                <span class="drt-logo">MedLog</span>
                <span class="drt-status" id="drt-status">Ready</span>
            </div>
            <div class="drt-controls">
                <button class="drt-btn-icon" id="drt-collapse" title="Collapse">&#x2015;</button>
                <button class="drt-btn-icon" id="drt-close" title="Close">&#x2715;</button>
            </div>
        </div>

        <div class="drt-body" id="drt-body">
            <!-- Compact patient display (shown during/after session) -->
            <div id="drt-patient-display" class="drt-patient-display" style="display: none;">
                <div class="drt-patient-avatar" id="drt-patient-avatar">RS</div>
                <div class="drt-patient-details">
                    <div class="drt-patient-name" id="drt-patient-name-display">Rahul Sharma</div>
                    <div class="drt-patient-meta">
                        <span class="drt-patient-tag" id="drt-patient-age-tag">45 yrs</span>
                        <span class="drt-patient-tag" id="drt-patient-gender-tag">Male</span>
                    </div>
                </div>
            </div>

            <!-- Full patient form (shown pre-session) -->
            <div id="drt-patient-form-section" class="drt-section drt-patient-form">
                <div class="drt-section-title">Patient Info</div>
                <div class="drt-form-row">
                    <input type="text" id="drt-patient-name" class="drt-input" placeholder="Patient Name" />
                </div>
                <div class="drt-form-row drt-form-row-split">
                    <input type="number" id="drt-patient-age" class="drt-input drt-input-small" placeholder="Age" min="0" max="150" />
                    <select id="drt-patient-gender" class="drt-input">
                        <option value="" disabled selected>Gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>

            <!-- Session controls -->
            <div class="drt-session-controls" id="drt-session-actions">
                <button id="drt-start-btn" class="drt-btn drt-btn-start">&#x25B6; Start Session</button>
                <button id="drt-stop-btn" class="drt-btn drt-btn-stop" disabled>&#x25A0; End Session</button>
            </div>

            <div class="drt-results" id="drt-results">
                <div class="drt-card drt-card-chief" id="card-chief">
                    <div class="drt-card-header">
                        <span class="drt-card-icon">&#x1FA7A;</span>
                        <span class="drt-card-title">Chief Complaint</span>
                        <span class="drt-card-badge" id="drt-badge-chief-complaint">PENDING</span>
                    </div>
                    <div class="drt-card-content drt-empty" id="drt-chief-complaint">Waiting for session to begin...</div>
                </div>
                <div class="drt-card drt-card-diagnosis" id="card-diagnosis">
                    <div class="drt-card-header">
                        <span class="drt-card-icon">&#x1F4CB;</span>
                        <span class="drt-card-title">Diagnosis</span>
                        <span class="drt-card-badge" id="drt-badge-diagnosis">PENDING</span>
                    </div>
                    <div class="drt-card-content drt-empty" id="drt-diagnosis">Waiting for session to begin...</div>
                </div>
                <div class="drt-card drt-card-medicine" id="card-medicine">
                    <div class="drt-card-header">
                        <span class="drt-card-icon">&#x1F48A;</span>
                        <span class="drt-card-title">Medicine</span>
                        <span class="drt-card-badge" id="drt-badge-medicine">PENDING</span>
                    </div>
                    <div class="drt-card-content drt-empty" id="drt-medicine">Waiting for session to begin...</div>
                </div>
                <div class="drt-card drt-card-advice" id="card-advice">
                    <div class="drt-card-header">
                        <span class="drt-card-icon">&#x1F4AC;</span>
                        <span class="drt-card-title">Advice</span>
                        <span class="drt-card-badge" id="drt-badge-advice">PENDING</span>
                    </div>
                    <div class="drt-card-content drt-empty" id="drt-advice">Waiting for session to begin...</div>
                </div>
                <div class="drt-card drt-card-nextsteps" id="card-nextsteps">
                    <div class="drt-card-header">
                        <span class="drt-card-icon">&#x27A1;</span>
                        <span class="drt-card-title">Next Steps</span>
                        <span class="drt-card-badge" id="drt-badge-next-steps">PENDING</span>
                    </div>
                    <div class="drt-card-content drt-empty" id="drt-next-steps">Waiting for session to begin...</div>
                </div>
            </div>
        </div>

        <div class="drt-footer">
            <span class="drt-footer-version">MedLog v2.1 &middot; HIPAA Compliant</span>
            <span class="drt-footer-status" id="drt-footer-status">&#x25CF; Not Recording</span>
        </div>
    </div>

    <!-- Toast -->
    <div class="drt-toast" id="drt-toast"></div>

    <!-- Simulation controls -->
    <div class="sim-controls">
        <div class="sim-label">EMR + MedLog Demo</div>
        <button id="sim-btn" onclick="toggleSimulation()">Play Full Demo</button>
        <button onclick="resetAll()">Reset</button>
        <div class="sim-timer" id="sim-timer"></div>
    </div>

    <script>
        // ─── Load jsPDF dynamically (works on file:// too) ──────
        (function loadJsPDF() {
            const script = document.createElement('script');
            script.src = 'jspdf.umd.min.js';
            script.onload = () => console.log('[Preview] jsPDF loaded');
            script.onerror = () => console.warn('[Preview] jsPDF failed to load - PDF export disabled');
            document.head.appendChild(script);
        })();

        // ─── Inline export helpers (no external deps needed) ────
        const PREVIEW_FIELD_KEYS = ['chief_complaint', 'diagnosis', 'medicine', 'advice', 'next_steps'];
        const PREVIEW_FIELD_LABELS = {
            chief_complaint: 'Chief Complaint', diagnosis: 'Diagnosis',
            medicine: 'Medicine', advice: 'Advice', next_steps: 'Next Steps'
        };

        function previewGetEditedData() {
            const data = {};
            for (const key of PREVIEW_FIELD_KEYS) {
                const el = document.getElementById('drt-edit-' + key);
                data[key] = el ? el.value.trim() : '';
            }
            return data;
        }

        function previewDateStr() {
            return new Date().toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        function previewTimestamp() {
            return new Date().toLocaleString('en-IN', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        function previewFormatText(patient) {
            const data = previewGetEditedData();
            const date = previewDateStr();
            const sep = '\u2550'.repeat(39);
            const thin = '\u2500'.repeat(39);
            const lines = [sep, '        CONSULTATION NOTES', sep, 'Date: ' + date, '',
                'PATIENT DETAILS', thin,
                'Name: ' + (patient.name||'-') + ' | Age: ' + (patient.age||'-') + ' | Gender: ' + (patient.gender||'-'), ''];
            for (const key of PREVIEW_FIELD_KEYS) {
                if (data[key]) { lines.push(PREVIEW_FIELD_LABELS[key].toUpperCase(), thin, data[key], ''); }
            }
            lines.push(sep, 'Generated by MedLog');
            return lines.join('\n');
        }

        function previewExportPDF(patient, doctorInfo) {
            const jsPDF = window.jspdf && window.jspdf.jsPDF;
            if (!jsPDF) {
                showToast('PDF library loading... try again in a moment');
                const s = document.createElement('script');
                s.src = 'jspdf.umd.min.js';
                document.head.appendChild(s);
                return;
            }
            const doc = new jsPDF('p', 'mm', 'a4');
            const pw = doc.internal.pageSize.getWidth();
            const ph = doc.internal.pageSize.getHeight();
            const m = 20;
            const cw = pw - m * 2;
            let y = m;
            const data = previewGetEditedData();
            const date = previewDateStr();

            function checkBreak(h) { if (y + h > ph - 25) { doc.addPage(); y = m; } }
            function writeWrap(text, x, sy, mw, lh) {
                const lines = doc.splitTextToSize(text, mw);
                for (const l of lines) { checkBreak(lh); doc.text(l, x, sy); sy += lh; }
                return sy;
            }

            const dn = (doctorInfo && doctorInfo.doctorName) || '';
            const cn = (doctorInfo && doctorInfo.clinicName) || '';
            if (dn) { doc.setFont('helvetica','bold'); doc.setFontSize(18); doc.text(dn, m, y); y += 7; }
            if (cn) { doc.setFont('helvetica','normal'); doc.setFontSize(11); doc.setTextColor(100,100,100); doc.text(cn, m, y); y += 5; }
            doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(100,100,100);
            doc.text('Date: ' + date, pw - m, dn ? m : y, { align: 'right' }); doc.setTextColor(0,0,0);
            if (dn || cn) y += 3;
            doc.setDrawColor(180,180,180); doc.setLineWidth(0.5); doc.line(m, y, pw - m, y); y += 8;
            doc.setFont('helvetica','normal'); doc.setFontSize(11);
            doc.text('Patient: ' + (patient.name||'-'), m, y);
            doc.text('Age: ' + (patient.age||'-') + '    Gender: ' + (patient.gender||'-'), m + 90, y); y += 10;
            doc.setFont('helvetica','bold'); doc.setFontSize(20); doc.text('Rx', m, y); y += 10;
            doc.setFontSize(11);
            for (const key of PREVIEW_FIELD_KEYS) {
                const val = data[key]; if (!val) continue;
                checkBreak(15);
                doc.setFont('helvetica','bold'); doc.setFontSize(11);
                doc.text(PREVIEW_FIELD_LABELS[key].toUpperCase(), m, y); y += 6;
                doc.setFont('helvetica','normal'); doc.setFontSize(10);
                y = writeWrap(val, m, y, cw, 5); y += 6;
            }
            doc.setFont('helvetica','normal'); doc.setFontSize(8); doc.setTextColor(150,150,150);
            doc.text('Generated by MedLog | ' + previewTimestamp(), m, ph - 10);
            const safeName = (patient.name || 'patient').replace(/[^a-zA-Z0-9]/g, '_').toLowerCase();
            doc.save('prescription_' + safeName + '_' + date.replace(/\s/g, '-') + '.pdf');
        }

        function previewExportTXT(patient) {
            const text = previewFormatText(patient);
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const safeName = (patient.name || 'patient').replace(/[^a-zA-Z0-9]/g, '_').toLowerCase();
            a.download = 'consultation_' + safeName + '_' + previewDateStr().replace(/\s/g, '-') + '.txt';
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 200);
        }

        // ─── Element refs ────────────────────────────────────────
        const statusEl = document.getElementById('drt-status');
        const bodyEl = document.getElementById('drt-body');
        const startBtn = document.getElementById('drt-start-btn');
        const stopBtn = document.getElementById('drt-stop-btn');
        const nameInput = document.getElementById('drt-patient-name');
        const ageInput = document.getElementById('drt-patient-age');
        const genderInput = document.getElementById('drt-patient-gender');
        const transcriptBar = document.getElementById('transcript-bar');
        const meetTime = document.getElementById('meet-time');
        const doctorRing = document.getElementById('doctor-ring');
        const patientRing = document.getElementById('patient-ring');
        const simBtn = document.getElementById('sim-btn');
        const simTimer = document.getElementById('sim-timer');
        const badge = document.getElementById('drt-badge');
        const panel = document.getElementById('drt-panel');
        const sessionActions = document.getElementById('drt-session-actions');
        const patientDisplay = document.getElementById('drt-patient-display');
        const patientFormSection = document.getElementById('drt-patient-form-section');
        const footerStatus = document.getElementById('drt-footer-status');

        // ─── Badge click -> toggle panel ────────────────────────
        badge.addEventListener('click', () => {
            if (panel.style.display === 'none') {
                panel.style.display = 'flex';
            } else {
                panel.style.display = 'none';
            }
        });

        // ─── Dragging ────────────────────────────────────────────
        const header = document.getElementById('drt-header');
        let isDragging = false, dragX = 0, dragY = 0;
        header.addEventListener('mousedown', (e) => {
            if (e.target.closest('.drt-btn-icon')) return;
            isDragging = true;
            dragX = e.clientX - panel.offsetLeft;
            dragY = e.clientY - panel.offsetTop;
            panel.style.transition = 'none';
        });
        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            e.preventDefault();
            panel.style.left = Math.max(0, Math.min(innerWidth - panel.offsetWidth, e.clientX - dragX)) + 'px';
            panel.style.top = Math.max(0, Math.min(innerHeight - panel.offsetHeight, e.clientY - dragY)) + 'px';
            panel.style.right = 'auto';
        });
        document.addEventListener('mouseup', () => { isDragging = false; panel.style.transition = ''; });

        // Collapse
        let isCollapsed = false;
        document.getElementById('drt-collapse').addEventListener('click', () => {
            isCollapsed = !isCollapsed;
            bodyEl.style.display = isCollapsed ? 'none' : '';
            document.querySelector('.drt-footer').style.display = isCollapsed ? 'none' : '';
            document.getElementById('drt-collapse').innerHTML = isCollapsed ? '&#x2B1C;' : '&#x2015;';
        });

        // Close
        document.getElementById('drt-close').addEventListener('click', () => {
            panel.style.display = 'none';
        });

        // ═══════════════════════════════════════════════════════════
        // SIMULATION ENGINE v2
        // Full flow: badge -> panel -> recording -> post-session
        // ═══════════════════════════════════════════════════════════

        let simRunning = false;
        let simTimeouts = [];
        let simElapsed = 0;
        let simInterval = null;
        let sessionPhase = 'pre'; // pre | recording | post

        const CONVERSATION = [
            {
                time: 0,
                speaker: 'doctor',
                dialogue: 'Good morning Rahul ji, how are you feeling today? What brings you in?',
                extraction: null
            },
            {
                time: 5,
                speaker: 'patient',
                dialogue: 'Doctor, I have been having a very bad headache for the last 3 days. It is worse when I wake up in the morning.',
                extraction: {
                    chief_complaint: 'Headache for 3 days, worse in the morning.',
                    diagnosis: '', medicine: '', advice: '', next_steps: ''
                },
                updatedCards: ['chief']
            },
            {
                time: 10,
                speaker: 'doctor',
                dialogue: 'I see. Is there any nausea or vomiting? Any sensitivity to light?',
                extraction: null
            },
            {
                time: 15,
                speaker: 'patient',
                dialogue: 'Yes, mild nausea is there but no vomiting. Light bothers me a little. Also feeling some neck stiffness.',
                extraction: {
                    chief_complaint: 'Headache for 3 days, worse in the morning. Associated with mild nausea and photosensitivity. Neck stiffness present. No vomiting.',
                    diagnosis: '', medicine: '', advice: '', next_steps: ''
                },
                updatedCards: ['chief']
            },
            {
                time: 20,
                speaker: 'doctor',
                dialogue: 'Any history of migraine in your family? Have you had any head injury recently?',
                extraction: null
            },
            {
                time: 25,
                speaker: 'patient',
                dialogue: 'No head injury. But my mother used to get migraines. I have been working very long hours on my laptop lately.',
                extraction: {
                    chief_complaint: 'Headache for 3 days, worse in the morning. Associated with mild nausea and photosensitivity. Neck stiffness present. No vomiting. No history of trauma. Family history of migraine (mother). Prolonged screen exposure.',
                    diagnosis: 'Tension-type headache, possibly migraine without aura. Rule out cervicogenic headache.',
                    medicine: '', advice: '', next_steps: ''
                },
                updatedCards: ['chief', 'diagnosis']
            },
            {
                time: 30,
                speaker: 'doctor',
                dialogue: 'Based on your symptoms, this looks like tension-type headache aggravated by screen time. I am going to prescribe some medicines. Take Paracetamol 500mg three times a day for 3 days.',
                extraction: {
                    chief_complaint: 'Headache for 3 days, worse in the morning. Associated with mild nausea and photosensitivity. Neck stiffness present. No vomiting. No history of trauma. Family history of migraine (mother). Prolonged screen exposure.',
                    diagnosis: 'Tension-type headache, possibly migraine without aura. Rule out cervicogenic headache.',
                    medicine: 'Tab. Paracetamol 500mg - 1 tablet TID x 3 days',
                    advice: '', next_steps: ''
                },
                updatedCards: ['medicine']
            },
            {
                time: 35,
                speaker: 'doctor',
                dialogue: 'Also take Domperidone 10mg if you feel nauseous. And a muscle relaxant - Thiocolchicoside 4mg twice a day for the neck stiffness.',
                extraction: {
                    chief_complaint: 'Headache for 3 days, worse in the morning. Associated with mild nausea and photosensitivity. Neck stiffness present. No vomiting. No history of trauma. Family history of migraine (mother). Prolonged screen exposure.',
                    diagnosis: 'Tension-type headache, possibly migraine without aura. Rule out cervicogenic headache.',
                    medicine: 'Tab. Paracetamol 500mg - 1 tablet TID x 3 days\nTab. Domperidone 10mg - 1 tablet SOS for nausea\nTab. Thiocolchicoside 4mg - 1 tablet BID x 5 days',
                    advice: '', next_steps: ''
                },
                updatedCards: ['medicine']
            },
            {
                time: 40,
                speaker: 'doctor',
                dialogue: 'Some important things - take proper rest, reduce screen time, follow the 20-20-20 rule. Stay well hydrated, at least 3 litres of water daily.',
                extraction: {
                    chief_complaint: 'Headache for 3 days, worse in the morning. Associated with mild nausea and photosensitivity. Neck stiffness present. No vomiting. No history of trauma. Family history of migraine (mother). Prolonged screen exposure.',
                    diagnosis: 'Tension-type headache, possibly migraine without aura. Rule out cervicogenic headache.',
                    medicine: 'Tab. Paracetamol 500mg - 1 tablet TID x 3 days\nTab. Domperidone 10mg - 1 tablet SOS for nausea\nTab. Thiocolchicoside 4mg - 1 tablet BID x 5 days',
                    advice: 'Adequate rest and hydration (3L water/day). Reduce prolonged screen time - follow 20-20-20 rule. Maintain regular sleep schedule. Neck stretching exercises.',
                    next_steps: ''
                },
                updatedCards: ['advice']
            },
            {
                time: 45,
                speaker: 'doctor',
                dialogue: 'Come back in one week if symptoms persist. If the headache gets significantly worse or you develop any vision changes, come to the ER immediately.',
                extraction: {
                    chief_complaint: 'Headache for 3 days, worse in the morning. Associated with mild nausea and photosensitivity. Neck stiffness present. No vomiting. No history of trauma. Family history of migraine (mother). Prolonged screen exposure.',
                    diagnosis: 'Tension-type headache, possibly migraine without aura. Rule out cervicogenic headache.',
                    medicine: 'Tab. Paracetamol 500mg - 1 tablet TID x 3 days\nTab. Domperidone 10mg - 1 tablet SOS for nausea\nTab. Thiocolchicoside 4mg - 1 tablet BID x 5 days',
                    advice: 'Adequate rest and hydration (3L water/day). Reduce prolonged screen time - follow 20-20-20 rule. Maintain regular sleep schedule. Neck stretching exercises.',
                    next_steps: 'Follow-up in 1 week if symptoms persist. ER visit if severe worsening or vision changes. MRI brain if no improvement after 1 week. Consider neurology referral if recurrent.'
                },
                updatedCards: ['nextsteps']
            },
            {
                time: 50,
                speaker: 'patient',
                dialogue: 'Thank you doctor. I will follow all of this. See you next week if needed.',
                extraction: null
            }
        ];

        // Store final extraction for post-session
        let finalExtraction = {};

        function toggleSimulation() {
            if (simRunning) {
                stopSimulation();
            } else {
                startSimulation();
            }
        }

        function startSimulation() {
            resetAll();
            simRunning = true;
            simBtn.textContent = 'Stop Simulation';
            simBtn.classList.add('sim-stop');

            // Phase 0: EMR form fills (0-1.5s)
            simTimeouts.push(setTimeout(() => {
                emrFillForm();
            }, 500));

            // Phase 0.5: EMR "Start Consult" clicked (1.5s)
            simTimeouts.push(setTimeout(() => {
                emrDisableForm();
                emrSetStatus('Connecting...', '');
            }, 1500));

            // Phase 0.7: EMR transitions to waiting, MedLog badge appears (2s)
            simTimeouts.push(setTimeout(() => {
                emrShowWaiting();
            }, 2000));

            // Phase 1: Badge pulses, then panel opens (2.5s)
            simTimeouts.push(setTimeout(() => {
                // Open panel
                panel.style.display = 'flex';

                // Show patient display immediately (data came from EMR)
                patientDisplay.style.display = 'flex';
                patientFormSection.style.display = 'none';
                document.getElementById('drt-patient-avatar').textContent = 'RS';
                document.getElementById('drt-patient-name-display').textContent = 'Rahul Sharma';
                document.getElementById('drt-patient-age-tag').textContent = '45 yrs';
                document.getElementById('drt-patient-gender-tag').textContent = 'Male';

                // Start connecting after 0.5s
                simTimeouts.push(setTimeout(() => {
                    setStatus('Connecting...', 'connecting');
                    startBtn.disabled = true;
                }, 500));

                // Start recording after 1.5s (relative to panel open)
                simTimeouts.push(setTimeout(() => {
                    sessionPhase = 'recording';
                    setStatus('Recording', 'recording');
                    stopBtn.disabled = false;
                    badge.classList.remove('drt-badge-detected');
                    badge.classList.add('drt-badge-active');

                    simElapsed = 0;

                    // Start timer
                    simInterval = setInterval(() => {
                        simElapsed++;
                        const mins = Math.floor(simElapsed / 60);
                        const secs = simElapsed % 60;
                        simTimer.textContent = `${mins}:${secs.toString().padStart(2, '0')} elapsed`;
                        meetTime.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                    }, 1000);

                    // Schedule conversation
                    CONVERSATION.forEach((step) => {
                        simTimeouts.push(setTimeout(() => {
                            showDialogue(step.speaker, step.dialogue);
                        }, step.time * 1000));

                        if (step.extraction) {
                            simTimeouts.push(setTimeout(() => {
                                finalExtraction = step.extraction;
                                updateCards(step.extraction, step.updatedCards);
                            }, (step.time + 3) * 1000));
                        }
                    });

                    // End recording -> transition to post-session
                    const lastTime = CONVERSATION[CONVERSATION.length - 1].time;
                    simTimeouts.push(setTimeout(() => {
                        hideDialogue();
                        doctorRing.classList.remove('active');
                        patientRing.classList.remove('active');
                        clearInterval(simInterval);

                        // Transition to post-session mode
                        transitionToPostSession();
                    }, (lastTime + 5) * 1000));

                }, 1500));
            }, 2500));
        }

        function transitionToPostSession() {
            sessionPhase = 'post';
            setStatus('Session Complete', '');
            stopBtn.disabled = true;
            badge.classList.remove('drt-badge-active');
            badge.classList.add('drt-badge-detected');

            // Update EMR waiting message
            const emrWaitingMsg = document.getElementById('emr-waiting-msg');
            if (emrWaitingMsg) {
                emrWaitingMsg.innerHTML = 'Session complete.<br>Click "Export to EMR" in MedLog panel to receive results.';
            }
            emrSetStatus('Waiting', '');

            // Hide session actions
            sessionActions.style.display = 'none';

            // Replace card content with textareas
            const fieldMap = {
                chief_complaint: 'drt-chief-complaint',
                diagnosis: 'drt-diagnosis',
                medicine: 'drt-medicine',
                advice: 'drt-advice',
                next_steps: 'drt-next-steps'
            };

            for (const [key, id] of Object.entries(fieldMap)) {
                const el = document.getElementById(id);
                if (!el) continue;
                const text = el.classList.contains('drt-empty') ? '' : el.textContent;
                const textarea = document.createElement('textarea');
                textarea.id = 'drt-edit-' + key;
                textarea.className = 'drt-card-textarea';
                textarea.value = text;
                textarea.placeholder = 'No data captured';
                textarea.rows = 3;
                el.parentNode.replaceChild(textarea, el);
            }

            // Add export bar
            const results = document.getElementById('drt-results');
            const exportBar = document.createElement('div');
            exportBar.id = 'drt-export-bar';
            exportBar.className = 'drt-export-bar';
            exportBar.innerHTML = `
                <div class="drt-section-title">Export</div>
                <div class="drt-export-actions">
                    <button class="drt-btn-export drt-btn-export-primary" id="drt-export-emr" style="grid-column: 1 / -1;">Export to EMR</button>
                    <button class="drt-btn-export" id="drt-export-pdf">Export PDF</button>
                    <button class="drt-btn-export" id="drt-export-email">Open in Gmail</button>
                    <button class="drt-btn-export" id="drt-export-clipboard">Copy to Clipboard</button>
                    <button class="drt-btn-export" id="drt-export-txt">Download TXT</button>
                </div>
                <button class="drt-btn-new-session" id="drt-new-session">+ New Session</button>
            `;
            results.parentNode.insertBefore(exportBar, results.nextSibling);

            // Wire export buttons using inline helpers
            const currentPatient = { name: 'Rahul Sharma', age: 45, gender: 'Male' };

            document.getElementById('drt-export-emr').addEventListener('click', () => {
                exportToEMRPanel();
                showToast('Results exported to EMR!');
            });
            document.getElementById('drt-export-pdf').addEventListener('click', () => {
                previewExportPDF(currentPatient, {
                    doctorName: 'Dr. Priya Mehta',
                    clinicName: 'City Health Clinic'
                });
            });
            document.getElementById('drt-export-email').addEventListener('click', () => {
                const text = previewFormatText(currentPatient);
                const subject = encodeURIComponent('Consultation Notes - ' + currentPatient.name + ' - ' + previewDateStr());
                const body = encodeURIComponent(text);
                window.open('https://mail.google.com/mail/?view=cm&su=' + subject + '&body=' + body, '_blank');
                copyToClipboard(text);
            });
            document.getElementById('drt-export-clipboard').addEventListener('click', () => {
                const text = previewFormatText(currentPatient);
                copyToClipboard(text);
            });
            document.getElementById('drt-export-txt').addEventListener('click', () => {
                previewExportTXT(currentPatient);
                showToast('TXT downloaded!');
            });
            document.getElementById('drt-new-session').addEventListener('click', () => {
                transitionToPreSession();
            });

            simRunning = false;
            simBtn.textContent = 'Play Full Demo';
            simBtn.classList.remove('sim-stop');

            // Scroll to show export bar
            const body = document.getElementById('drt-body');
            body.scrollTop = body.scrollHeight;
        }

        function transitionToPreSession() {
            sessionPhase = 'pre';

            const fieldMap = {
                chief_complaint: 'drt-chief-complaint',
                diagnosis: 'drt-diagnosis',
                medicine: 'drt-medicine',
                advice: 'drt-advice',
                next_steps: 'drt-next-steps'
            };

            for (const [key, id] of Object.entries(fieldMap)) {
                const textarea = document.getElementById('drt-edit-' + key);
                if (!textarea) continue;
                const div = document.createElement('div');
                div.id = id;
                div.className = 'drt-card-content drt-empty';
                div.textContent = 'Waiting for session to begin...';
                textarea.parentNode.replaceChild(div, textarea);
            }

            // Reset all card badges to PENDING
            const badgeIds = ['drt-badge-chief-complaint', 'drt-badge-diagnosis', 'drt-badge-medicine', 'drt-badge-advice', 'drt-badge-next-steps'];
            for (const id of badgeIds) {
                const el = document.getElementById(id);
                if (el) {
                    el.textContent = 'PENDING';
                    el.classList.remove('drt-badge-updated');
                }
            }

            const exportBar = document.getElementById('drt-export-bar');
            if (exportBar) exportBar.remove();

            // Show form, hide patient display
            patientFormSection.style.display = '';
            patientDisplay.style.display = 'none';

            sessionActions.style.display = '';
            setStatus('Ready', '');
            startBtn.disabled = false;
            stopBtn.disabled = true;
            nameInput.disabled = false;
            ageInput.disabled = false;
            genderInput.disabled = false;
            nameInput.value = '';
            ageInput.value = '';
            genderInput.value = '';
            simTimer.textContent = '';
            meetTime.textContent = '0:00';

            // Reset EMR panel
            emrResetAll();
        }

        function stopSimulation() {
            simTimeouts.forEach(t => clearTimeout(t));
            simTimeouts = [];
            if (simInterval) clearInterval(simInterval);
            simRunning = false;
            simBtn.textContent = 'Play Full Demo';
            simBtn.classList.remove('sim-stop');
            hideDialogue();
            doctorRing.classList.remove('active');
            patientRing.classList.remove('active');
        }

        function resetAll() {
            stopSimulation();

            // Reset to pre-session if in post
            if (sessionPhase === 'post') {
                transitionToPreSession();
            }

            setStatus('Ready', '');
            startBtn.disabled = false;
            stopBtn.disabled = true;
            nameInput.disabled = false;
            ageInput.disabled = false;
            genderInput.disabled = false;
            nameInput.value = '';
            ageInput.value = '';
            genderInput.value = '';
            simTimer.textContent = '';
            meetTime.textContent = '0:00';
            sessionPhase = 'pre';
            panel.style.display = 'none';
            badge.classList.remove('drt-badge-active');
            badge.classList.add('drt-badge-detected');

            // Show form, hide patient display
            patientFormSection.style.display = '';
            patientDisplay.style.display = 'none';

            // Reset card content
            document.querySelectorAll('.drt-card-content').forEach(el => {
                el.textContent = 'Waiting for session to begin...';
                el.className = 'drt-card-content drt-empty';
            });
            document.querySelectorAll('.drt-card').forEach(el => {
                el.classList.remove('drt-card-updating');
            });

            // Reset all card badges to PENDING
            const badgeIds = ['drt-badge-chief-complaint', 'drt-badge-diagnosis', 'drt-badge-medicine', 'drt-badge-advice', 'drt-badge-next-steps'];
            for (const id of badgeIds) {
                const el = document.getElementById(id);
                if (el) {
                    el.textContent = 'PENDING';
                    el.classList.remove('drt-badge-updated');
                }
            }

            // Reset EMR panel
            emrResetAll();
        }

        function setStatus(text, state) {
            statusEl.textContent = text;
            statusEl.className = 'drt-status';
            if (state) statusEl.classList.add('drt-status-' + state);

            // Update footer status
            if (state === 'recording') {
                footerStatus.textContent = '\u25CF Recording';
                footerStatus.className = 'drt-footer-status drt-footer-recording';
            } else {
                footerStatus.textContent = '\u25CF Not Recording';
                footerStatus.className = 'drt-footer-status';
            }
        }

        function showDialogue(speaker, text) {
            doctorRing.classList.toggle('active', speaker === 'doctor');
            patientRing.classList.toggle('active', speaker === 'patient');
            const label = speaker === 'doctor' ? 'Dr. Mehta' : 'Rahul';
            transcriptBar.innerHTML = `<span class="speaker">${label}:</span> "${text}"`;
            transcriptBar.classList.add('visible');
        }

        function hideDialogue() {
            transcriptBar.classList.remove('visible');
        }

        function updateCards(extraction, updatedCardIds) {
            const mapping = {
                chief_complaint: { el: 'drt-chief-complaint', card: 'card-chief', badge: 'drt-badge-chief-complaint' },
                diagnosis:       { el: 'drt-diagnosis',        card: 'card-diagnosis', badge: 'drt-badge-diagnosis' },
                medicine:        { el: 'drt-medicine',         card: 'card-medicine', badge: 'drt-badge-medicine' },
                advice:          { el: 'drt-advice',           card: 'card-advice', badge: 'drt-badge-advice' },
                next_steps:      { el: 'drt-next-steps',       card: 'card-nextsteps', badge: 'drt-badge-next-steps' }
            };

            for (const [key, val] of Object.entries(mapping)) {
                const contentEl = document.getElementById(val.el);
                const cardEl = document.getElementById(val.card);
                const badgeEl = document.getElementById(val.badge);
                const text = extraction[key];

                if (text && text.trim() && contentEl) {
                    contentEl.textContent = text;
                    contentEl.classList.remove('drt-empty');

                    // Update badge to UPDATED
                    if (badgeEl) {
                        badgeEl.textContent = 'UPDATED';
                        badgeEl.classList.add('drt-badge-updated');
                    }

                    if (updatedCardIds && updatedCardIds.some(id => val.card.includes(id))) {
                        cardEl.classList.add('drt-card-updating');
                        setTimeout(() => cardEl.classList.remove('drt-card-updating'), 1500);
                    }
                }
            }

            const body = document.getElementById('drt-body');
            if (updatedCardIds) {
                const lastCard = updatedCardIds[updatedCardIds.length - 1];
                const targetCard = document.getElementById('card-' + lastCard);
                if (targetCard) {
                    targetCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }
        }

        function copyToClipboard(text) {
            try {
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(text).then(() => {
                        showToast('Copied to clipboard!');
                    }).catch(() => {
                        execCopyFallback(text);
                    });
                } else {
                    execCopyFallback(text);
                }
            } catch (e) {
                execCopyFallback(text);
            }
        }

        function execCopyFallback(text) {
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.left = '-9999px';
            ta.style.top = '-9999px';
            document.body.appendChild(ta);
            ta.focus();
            ta.select();
            try {
                document.execCommand('copy');
                showToast('Copied to clipboard!');
            } catch (e) {
                showToast('Copy failed - select text manually');
            }
            document.body.removeChild(ta);
        }

        function showToast(message) {
            const toast = document.getElementById('drt-toast');
            toast.textContent = message;
            toast.classList.add('drt-toast-visible');
            setTimeout(() => {
                toast.classList.remove('drt-toast-visible');
            }, 2000);
        }

        // ═══════════════════════════════════════════════════════════
        // EMR PANEL LOGIC
        // ═══════════════════════════════════════════════════════════

        const emrFormSection = document.getElementById('emr-form-section');
        const emrWaitingSection = document.getElementById('emr-waiting-section');
        const emrResultsSection = document.getElementById('emr-results-section');
        const emrStatus = document.getElementById('emr-status');

        function emrSetStatus(text, state) {
            emrStatus.textContent = text;
            emrStatus.className = 'emr-panel-status';
            if (state) emrStatus.classList.add('emr-status-' + state);
        }

        function emrShowForm() {
            emrFormSection.style.display = '';
            emrWaitingSection.style.display = 'none';
            emrResultsSection.style.display = 'none';
            emrSetStatus('Ready', '');
            // Re-enable form
            document.querySelectorAll('#emr-form-section input, #emr-form-section select, #emr-form-section textarea').forEach(el => el.disabled = false);
            document.getElementById('emr-start-btn').disabled = false;
        }

        function emrShowWaiting() {
            emrFormSection.style.display = 'none';
            emrWaitingSection.style.display = '';
            emrResultsSection.style.display = 'none';
            emrSetStatus('Recording', 'active');
        }

        function emrShowResults(extraction) {
            emrFormSection.style.display = 'none';
            emrWaitingSection.style.display = 'none';
            emrResultsSection.style.display = '';
            emrSetStatus('Received', 'received');

            const mapping = {
                chief_complaint: 'emr-res-chief',
                diagnosis: 'emr-res-diagnosis',
                medicine: 'emr-res-medicine',
                advice: 'emr-res-advice',
                next_steps: 'emr-res-nextsteps'
            };

            for (const [key, id] of Object.entries(mapping)) {
                const el = document.getElementById(id);
                const val = extraction[key];
                if (el) {
                    if (val && val.trim()) {
                        el.textContent = val;
                        el.classList.remove('emr-empty');
                    } else {
                        el.textContent = '--';
                        el.classList.add('emr-empty');
                    }
                }
            }
        }

        function exportToEMRPanel() {
            // Get the edited values from post-session textareas
            const extraction = {};
            for (const key of PREVIEW_FIELD_KEYS) {
                const el = document.getElementById('drt-edit-' + key);
                extraction[key] = el ? el.value.trim() : '';
            }
            emrShowResults(extraction);
        }

        function emrFillForm() {
            document.getElementById('emr-appointment-id').value = 'APT-2024-001';
            document.getElementById('emr-patient-name').value = 'Rahul Sharma';
            document.getElementById('emr-patient-age').value = '45';
            document.getElementById('emr-patient-gender').value = 'Male';
            document.getElementById('emr-patient-history').value = 'No known allergies. Previous consultation for seasonal allergies (2023). Family history: Mother - migraine, Father - hypertension.';
            document.getElementById('emr-gmeet-link').value = 'https://meet.google.com/rxj-knwb-yzm';
        }

        function emrDisableForm() {
            document.querySelectorAll('#emr-form-section input, #emr-form-section select, #emr-form-section textarea').forEach(el => el.disabled = true);
            document.getElementById('emr-start-btn').disabled = true;
        }

        function emrResetAll() {
            emrShowForm();
            document.getElementById('emr-patient-name').value = '';
            document.getElementById('emr-patient-age').value = '';
            document.getElementById('emr-patient-gender').value = '';
            document.getElementById('emr-patient-history').value = '';
        }
    </script>
</body>
</html>
